---
title: "è¨€èªãŒé•ã†è¤‡æ•°ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’monorepoã¸ç§»è¡Œã—ãŸè©±"
emoji: "ğŸšš"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["monorepo","polyrepo"]
published: true
publication_name: "moneyforward"
---
# å°å…¥

æœ€è¿‘ç§ã¯ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§é–‹ç™ºã—ã¦ã„ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’Monorepoã«ç§»è¡Œã™ã‚‹æ©Ÿä¼šãŒã‚ã£ãŸã®ã§ã€ãã‚Œã«è‡³ã£ãŸçµŒç·¯ã‚„ã©ã®ã‚ˆã†ã«ç§»è¡Œã—ãŸã‹ã€ãã—ã¦ã€ç§»è¡Œã—ã¦ã©ã‚“ãªå•é¡ŒãŒè§£æ±ºã•ã‚ŒãŸã‹ã«ã¤ã„ã¦ã¾ã¨ã‚ãŸã„ã¨æ€ã„ã¾ã™ã€‚

ã¡ãªã¿ã«ã€ç§ã®Monorepoã§ã®é–‹ç™ºçµŒé¨“ã¯çš†ç„¡ã§ã™ã®ã§ã€ã“ã®è¨˜äº‹ã¯Monorepoã®æ­£è§£ã‚’æç¤ºã™ã‚‹ã‚‚ã®ã§ã¯ãªãã€ã‚ãã¾ã§ç§ãŸã¡ãŒæŠ±ãˆã¦ã„ãŸå•é¡Œã‚’è§£æ¶ˆã™ã‚‹ãŸã‚ã«è¡Œã£ãŸä¸€ã¤ã®ã‚±ãƒ¼ã‚¹ã§ã‚ã‚‹ã“ã¨ã¯ã”äº†æ‰¿ãã ã•ã„ã€‚

# Monorepoã¨ã¯

Monorepoã¯ã€è¤‡æ•°ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’å˜ä¸€ã®ãƒªãƒã‚¸ãƒˆãƒªã§ç®¡ç†ã™ã‚‹é–‹ç™ºæ‰‹æ³•ã§ã™ã€‚ä¸€æ–¹ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¯ã«ãƒªãƒã‚¸ãƒˆãƒªã‚’åˆ†å‰²ã—ã¦ã€å€‹ã€…ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç‹¬ç«‹ã—ã¦ç®¡ç†ã™ã‚‹æ–¹æ³•ã‚’Polyrepoã¨å‘¼ã³ã¾ã™ã€‚

# ãƒãƒ¼ãƒ æ§‹æˆ

ç§ãŸã¡ã®ç¾åœ¨ã®ãƒãƒ¼ãƒ æ§‹æˆã§ã™ã€‚

| å½¹å‰²             | äººæ•°         |
|----------------|------------|
| PdM            | 1äºº         |
| ãƒ‡ã‚¶ã‚¤ãƒŠãƒ¼          | 1äºº         |
| Backend ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢  | 3äººï¼ˆã†ã¡1äººEMï¼‰ |
| Frontend ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ | 3äºº         |

# Monorepoç§»è¡Œå‰

monorepoã«ç§»è¡Œã™ã‚‹å‰ã¯ã€ä»¥ä¸‹ã®ã‚ˆã†ãªpolyrepoæ§‹æˆã§ã—ãŸã€‚

| ãƒªãƒã‚¸ãƒˆãƒª         | ãƒ—ãƒ­ã‚°ãƒ©ãƒ è¨€èª    | å½¹å‰²                                                                     |
|---------------|------------|------------------------------------------------------------------------|
| project       | ãªã—         | PdMãŒç®¡ç†ã™ã‚‹Epic issueã‚„ä»•æ§˜æ›¸ã€ä»–ãƒãƒ¼ãƒ å‘ã‘ã®ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ãªã©ã‚’ç®¡ç†ã—ã¾ã™ã€‚                          |
| project_api   | kotlin     | ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã‚„ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã®ã‚¿ã‚¹ã‚¯ã‚’ç®¡ç†ã™ã‚‹issueã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é ˜åŸŸã«ãŠã‘ã‚‹é–‹ç™ºè€…å‘ã‘ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãªã©ã‚’ç®¡ç†ã—ã¾ã™ã€‚ |
| project_front | typescript | project_apiã¨åŒæ§˜                                                         |

:::message
ä¸Šè¨˜ãƒªãƒã‚¸ãƒˆãƒªåã®*project*ã«ã¯ã€ç§ãŸã¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆåãŒå…¥ã‚Šã¾ã™ã€‚
:::

![our team and polyrepo](/images/articles/migrating-to-a-monorepo/our-team-and-polyrepo.png)

å‰²ã¨ã‚ˆãã‚ã‚‹æ§‹æˆã‹ãªã¨æ€ã„ã¾ã™ãŒã€ç§ãŸã¡ã¯ä¸»ã« **"ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç®¡ç†ã®é›£ã—ã•"**ã¨**"å…±æœ‰ãƒªã‚½ãƒ¼ã‚¹ã®ç®¡ç†ã‚³ã‚¹ãƒˆ"**ã€**"åˆ†æ¥­åˆ¶ã«ã‚ˆã‚‹ãƒãƒ¼ãƒ å†…ã®åˆ†æ–­"** ã«èª²é¡Œæ„Ÿã‚’æŒã£ã¦ã„ã¾ã—ãŸã€‚ãã‚Œãã‚Œã®å•é¡Œã¨ãã‚Œã‚‰ãŒè§£æ±ºã•ã‚Œã©ã®ã‚ˆã†ã«ãªã£ãŸã‹ã‚’è©³ç´°ã«è¦‹ã¦ã„ãã¾ã—ã‚‡ã†ã€‚

# æŠ±ãˆã¦ã„ãŸå•é¡Œã¨Monorepoç§»è¡Œå¾Œ

ç§ãŸã¡ãŒæŠ±ãˆã¦ã„ãŸå•é¡ŒãŒmonorepoç§»è¡Œã«ã‚ˆã£ã¦ã©ã®ã‚ˆã†ã«è§£æ±ºã•ã‚ŒãŸã‹ã‚’ã¾ã¨ã‚ã¾ã™ã€‚

## ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒåˆ†æ•£ã—ã¦æ¢ã—ã«ãã„å•é¡Œ

### Before

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒè¤‡æ•°ã®ãƒªãƒã‚¸ãƒˆãƒªã«åˆ†æ•£ã™ã‚‹ãŸã‚ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ¤œç´¢æ€§ã‚„ä¸€è¦§æ€§ãŒä½ä¸‹ã—ã¦ãŠã‚Šã€ç§ãŸã¡ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«ã¤ã„ã¦çŸ¥ã‚ŠãŸã„äººãŒæƒ…å ±ã‚’æ¢ã™ã®ãŒé›£ã—ã„å•é¡ŒãŒã‚ã‚Šã¾ã—ãŸã€‚ä»–æ–¹ã§ã€ç§ãŸã¡è‡ªèº«ã‚‚ã€ã©ã“ã«æƒ…å ±ã‚’æ®‹ã™ã‹ã§è¿·ã†ã“ã¨ã‚‚å°‘ãªãã‚ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚

### After

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã™ã‚‹æƒ…å ±ãŒ1ã¤ã®ãƒªãƒã‚¸ãƒˆãƒªã«é›†ç´„ã•ã‚ŒãŸãŸã‚ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ¢ã—ã‚„ã™ã•ãŒå‘ä¸Šã—ã¾ã—ãŸã€‚ã¾ãŸã€ç§ãŸã¡è‡ªèº«ã€ã©ã®ãƒªãƒã‚¸ãƒˆãƒªã«æƒ…å ±ã‚’ç½®ãã‹ã¨ã„ã†è¿·ã„ã¯ãªããªã‚Šã¾ã—ãŸã€‚ãã—ã¦ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã«é–¢ã™ã‚‹æ§˜ã€…ãªãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ä¸€ç®‡æ‰€ã«é›†ç´„ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã®ã§ã€ã‚ˆã‚Šè‰¯ã„ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆæ§‹æˆã‚’è€ƒãˆã‚‰ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«å¤–ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒé™³è…åŒ–ã—ãŒã¡

### Before

åŸºæœ¬çš„ã«é–‹ç™ºè€…ã¯ã€é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã®ä¸­ã§ã‚³ãƒ¼ãƒ‰ã¨ä¸€ç·’ã«ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã™ã‚‹æ„è­˜ãŒã‚ã‚Šã¾ã™ãŒã€ãƒªãƒã‚¸ãƒˆãƒªå¤–ã«ã‚ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¸ã®æ„è­˜ã¯è–„ã‚ŒãŒã¡ã§ã™ã€‚ã“ã®ãŸã‚ã€ã‚³ãƒ¼ãƒ‰ã¨åˆ¥ã®å ´æ‰€ã«ç½®ã‹ã‚ŒãŸãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æ›´æ–°ãŒæ°—ã¥ã„ãŸæ™‚ã«ãªã£ã¦ã—ã¾ã£ãŸã‚Šã€ãã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’æ›´æ–°ã™ã‚‹ã®ãŒä½œæˆè€…ã ã‘ã«ãªã£ã¦ã—ã¾ã†ã“ã¨ãŒã‚ã‚Šã¾ã—ãŸã€‚

### After

1ã‚³ãƒŸãƒƒãƒˆã§å…¨ã¦ã®æƒ…å ±ã‚’ç·¨é›†å¯èƒ½ã«ãªã‚Šã€ã‚ã‚‰ã‚†ã‚‹æƒ…å ±ãŒé–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã®ä¸­ã§æ›´æ–°ã•ã‚Œã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã—ãŸã€‚

## GitHubã®è¨­å®šã‚’åŒæœŸã™ã‚‹ã‚³ã‚¹ãƒˆ

### Before

ãƒªãƒã‚¸ãƒˆãƒªã®ãƒ©ãƒ™ãƒ«ã‚„è¨­å®šå€¤ã¯ãƒªãƒã‚¸ãƒˆãƒªã®æ•°ã ã‘æ‰‹ä½œæ¥­ã§åŒæœŸã—ã¦ã„ã¾ã—ãŸã€‚

### After

GitHubã®ãƒ©ãƒ™ãƒ«ã‚„è¨­å®šå€¤ã®å¤‰æ›´ç®‡æ‰€ãŒä¸€ç®‡æ‰€ã«ãªã‚Šç®¡ç†ã‚³ã‚¹ãƒˆã‚’å‰Šæ¸›ã§ãã¾ã—ãŸã€‚

## å…±é€šã®ãƒ“ãƒ«ãƒ‰ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã®ç®¡ç†ã‚³ã‚¹ãƒˆ

### Before

ãƒãƒãƒ¼ãƒ•ã‚©ãƒ¯ãƒ¼ãƒ‰ã§ã¯ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã„ãã¤ã‹æ±ºã‚ã‚‰ã‚ŒãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã®ã§ã€ç§ãŸã¡ãŒç®¡ç†ã™ã‚‹å…¨ã¦ã®ãƒªãƒã‚¸ãƒˆãƒªã§ã‚‚å…¨ãåŒã˜CIã®è¨­å®šã‚’è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ãŸã‚ã€ãƒªãƒã‚¸ãƒˆãƒªã‚’å¢—ã‚„ã™ãŸã³ã«ã€CIã®è¨­å®šã‚’ã‚³ãƒ”ãƒ¼ã—ãŸã‚Šã€å¤‰æ›´ã‚’åæ˜ ã—ãŸã‚Šã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

### After

å…±é€šã®ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–ã‚„ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ—ãƒ­ã‚»ã‚¹ã®å¤‰æ›´ç®‡æ‰€ãŒä¸€ç®‡æ‰€ã«ãªã‚Šç®¡ç†ã‚³ã‚¹ãƒˆãŒå‰Šæ¸›ã•ã‚Œã¾ã—ãŸã€‚

## åˆ†æ¥­åˆ¶ã«ã‚ˆã‚‹ãƒãƒ¼ãƒ å†…ã®åˆ†æ–­

### Before

ç§ãŸã¡ã®é–‹ç™ºãƒãƒ¼ãƒ ã¯å…ƒã‚ˆã‚Šã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’åˆ†æ¥­åˆ¶ã§é–‹ç™ºã—å§‹ã‚ãŸãŸã‚ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¨ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒªãƒã‚¸ãƒˆãƒªã¯è‡ªç„¶ã¨åˆ†ã‹ã‚Œã¦ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸã€‚ãã®çŠ¶æ³ãŒç¶šãã€è‡ªèº«ãŒãƒ¡ã‚¤ãƒ³ã§é–‹ç™ºã™ã‚‹ãƒªãƒã‚¸ãƒˆãƒªã«é›†ä¸­ã™ã‚‹ã‚ˆã†ã«ãªã£ãŸçµæœã€å¤§ããè¤‡é›‘ã«ãªã£ãŸã©ã¡ã‚‰ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚‚ç²¾é€šã—ãŸãƒ¡ãƒ³ãƒãƒ¼ãŒã„ãªããªã‚Šã€äº’ã„ã®ãƒªãƒã‚¸ãƒˆãƒªã«ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ã“ã¨ã®å¿ƒç†çš„ãƒãƒ¼ãƒ‰ãƒ«ãŒé«˜ã¾ã£ã¦ã—ã¾ã„ã¾ã—ãŸã€‚ãã†ã—ã¦ã€ãƒãƒ¼ãƒ å†…ã®åˆ†æ–­ã‚’æ‹›ã„ã¦ã„ã¾ã—ãŸã€‚

### After

ãƒªãƒã‚¸ãƒˆãƒªã¨ã„ã†éš”ãŸã‚Šã¯äºˆæƒ³ä»¥ä¸Šã«å¿ƒç†çš„ã«å½±éŸ¿ã‚’åŠã¼ã—ã¦ã„ãŸã‚ˆã†ã§ã€monorepoã«ãªã‚Š1ã‚³ãƒŸãƒƒãƒˆã§è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å¤‰æ›´ã§ãã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã§ã€è‡ªåˆ†ã®å¤‰æ›´ã«ã‚ˆã£ã¦ä»–æ–¹ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚‚å¤‰æ›´ãŒå¿…è¦ãªå ´é¢ã§ã€ä»Šã¾ã§è§¦ã£ã¦ã“ãªã‹ã£ãŸä»–æ–¹ã®ã‚³ãƒ¼ãƒ‰ã‚‚ä¸€ç·’ã«å¤‰æ›´ã—ã¦ã—ã¾ãŠã†ã¨æ€ã†ãƒ¡ãƒ³ãƒãƒ¼ãŒå‡ºã¦ãã¾ã—ãŸã€‚ã“ã®ã‚ˆã†ã«ã€monorepoã«ã™ã‚‹ã“ã¨ã§ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ¡ãƒ³ã‚¿ãƒ«ãƒ¢ãƒ‡ãƒ«ãŒå¤‰åŒ–ã—ã€ä»–ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é–‹ç™ºã™ã‚‹æ–¹æ³•ã‚’å­¦ã¼ã†ã¨ã—ãŸã‚Šã€ãƒ—ãƒ«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’è¦‹ã‚ˆã†ã¨ã™ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒå¢—ãˆã¦ããŸã“ã¨ã¯å¬‰ã—ã„å¤‰åŒ–ã§ã™ã€‚monorepoã«ã—ãŸã“ã¨ã§ãƒãƒ¼ãƒ å†…ã®å¿ƒç†çš„ãªå£ãŒè§£æ¶ˆã•ã‚ŒãŸã¨æ„Ÿã˜ã¦ã„ã¾ã™ã€‚ã“ã‚Œã‹ã‚‰ã•ã‚‰ã«ã‚³ãƒ©ãƒœãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ãŒç”Ÿã¾ã‚Œã¦ã„ãã“ã¨æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚

# åƒ•ãŸã¡ã®Monorepo 1.0

Monorepoã¨ã„ã£ã¦ã‚‚ã„ã‚ã„ã‚ãªã‚„ã‚Šæ–¹ãŒã‚ã‚Šã¾ã™ãŒã€ã“ã“ã§ã¯åƒ•ãŸã¡ã®Monorepo 1.0ãŒã©ã®ã‚ˆã†ã«æ§‹æˆã•ã‚ŒãŸã‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚

## Monorepoç§»è¡Œã®ã‚´ãƒ¼ãƒ«

ä»Šå›ã®Monorepoç§»è¡Œä½œæ¥­ã¯ã€**project_apiã€project_frontãƒªãƒã‚¸ãƒˆãƒªã‚’projectãƒªãƒã‚¸ãƒˆãƒªã«çµ±åˆã—projectãƒªãƒã‚¸ãƒˆãƒªã§ã“ã‚Œã¾ã§é€šã‚Šã®é–‹ç™ºã‚µã‚¤ã‚¯ãƒ«ã‚’å›ã›ã‚‹çŠ¶æ…‹**ã‚’ç›®æŒ‡ã—ã¾ã—ãŸã€‚

## ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«

ä»Šå›[Turbo](https://turbo.build/)ã‚„[nx](https://nx.dev/)ãªã©ã®ãƒ¢ãƒãƒ¬ãƒã‚’åŠ¹ç‡çš„ã«ç®¡ç†ã™ã‚‹ãŸã‚ã®ãƒ„ãƒ¼ãƒ«ã¯å°å…¥ã—ã¾ã›ã‚“ã§ã—ãŸã€‚

ç†ç”±ã¯ã€æ—¢å­˜ã®polyrepoã¯æ—¢ã«ãã‚Œãã‚Œé•ã†è¨€èªã§é•ã†ãƒ“ãƒ«ãƒ‰ãƒ„ãƒ¼ãƒ«ã§æ—¢ã«é–‹ç™ºã€é‹ç”¨ã•ã‚Œã¦ããŸã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®ã‚ˆã†ãªpolyrepoã‚’ä¸€ã¤ã®ç®¡ç†ãƒ„ãƒ¼ãƒ«ã«çµ±åˆã™ã‚‹ã«ã¯ã€CI/CDã®å†æ§‹ç¯‰ã‚„æ–°ãŸãªãƒ„ãƒ¼ãƒ«ã®å­¦ç¿’ã‚³ã‚¹ãƒˆãŒå¿…è¦ã«ãªã£ãŸã‚Šã€é‹ç”¨ä½“åˆ¶ã‚’å¤§ããå¤‰ãˆã‚‹å¿…è¦ãŒã‚ã‚‹ã“ã¨ãŒæƒ³å®šã•ã‚Œã¾ã—ãŸã€‚æœ€åˆã‹ã‚‰monorepoç’°å¢ƒã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å§‹ã‚ã‚‹ãªã‚‰ã¾ã ã—ã‚‚ã€ç§ãŸã¡ãŒè§£æ¶ˆã—ãŸã„èª²é¡Œã«å¯¾ã—ã¦ã¯too muchã ã¨è€ƒãˆãŸã®ã§ã€ã“ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å°å…¥ã™ã‚‹ã“ã¨ã¯è¦‹é€ã‚Šã¾ã—ãŸã€‚

## ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ 

ç§ãŸã¡ã¯ã€ã“ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ ã«ã—ã¾ã—ãŸã€‚`apps`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ãƒ«ãƒ¼ãƒˆã«ä½œæˆã—ã€`apps`ãƒ•ã‚©ãƒ«ãƒ€å†…ã«polyrepoã ã£ãŸå„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’é…ç½®ã—ã¾ã—ãŸã€‚docsã¯ã€ã™ãã«ç›®ã«ã¤ãã‚ˆã†ã«ãƒ«ãƒ¼ãƒˆã«é…ç½®ã—ã¾ã—ãŸã€‚

```shell:ãƒ•ã‚©ãƒ«ãƒ€æ§‹é€ 
.circleci
.github
apps
â”œ backend # å…ƒproject_apiãƒªãƒã‚¸ãƒˆãƒª(kotlin)
â”” web     # å…ƒproject_frontãƒªãƒã‚¸ãƒˆãƒª(typescript)
docs
```

ãƒ«ãƒ¼ãƒˆã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãã®ã¾ã¾é…ç½®ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚æ¤œè¨ã—ã¾ã—ãŸãŒã€ãƒ«ãƒ¼ãƒˆãŒè‚¥å¤§åŒ–ã—è¦‹é€šã—ãŒæ‚ªããªã‚‹ã“ã¨ãŒäºˆæƒ³ã•ã‚ŒãŸãŸã‚ã€`apps`ãƒ•ã‚©ãƒ«ãƒ€ã‚’ä½œæˆã—ã¾ã—ãŸã€‚

## ç§»è¡Œæ™‚ã«ã‚„ã£ãŸã“ã¨/è«¦ã‚ãŸã“ã¨

### ã‚„ã£ãŸã“ã¨

* **gitã‚³ãƒŸãƒƒãƒˆã®ç§»è¡Œ** - ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’ç§»è¡Œã™ã‚‹ã¨ç§»è¡Œå¾Œã«ãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´å±¥æ­´ã‚’é¡ã£ã¦ã‚‚ç§»è¡Œæ™‚ç‚¹ã®å·¨å¤§ãªã‚³ãƒŸãƒƒãƒˆã«ã—ã‹è¾¿ã‚Œãªããªã£ã¦ã—ã¾ã†ã®ã§å°†æ¥èª°ã‹ãŒå›°ã£ã¦ã—ã¾ã„ã¾ã™ã€‚ãã®ãŸã‚ã€[tomono](https://github.com/hraban/tomono)ã‚’ä½¿ã£ã¦polyrepoã®ãƒ•ã‚¡ã‚¤ãƒ«ã¨gitã‚³ãƒŸãƒƒãƒˆã‚’ç§»è¡Œã—ã¾ã—ãŸã€‚
* **issueã®ç§»è¡Œ** - polyrepoã®openãªissueã¯monorepoã«ç§»è¡Œã—ã¾ã—ãŸã€‚
* **ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã®issue/PRç•ªå·ã®ä¸€æ‹¬å¤‰æ›** - GitHubã¯ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã®ã€Œ#issueç•ªå·ã€ã®å½¢å¼ã§æ›¸ã‹ã‚ŒãŸæ–‡å­—åˆ—ã‚’åŒãƒªãƒã‚¸ãƒˆãƒªã®issue/PRç•ªå·ã¨ã—ã¦è§£é‡ˆã—ã¦ç”»é¢ã«ãƒªãƒ³ã‚¯ã§è¡¨ç¤ºã—ã¾ã™ã€‚ã‚³ãƒŸãƒƒãƒˆã¯åˆ¥ã®ãƒªãƒã‚¸ãƒˆãƒªã¸ã‚³ãƒ”ãƒ¼ã™ã‚‹ã®ã§ã€ä½•ã‚‚ã—ãªã‘ã‚Œã°ãƒªãƒ³ã‚¯ãŒæ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã«å‘ãã€ãƒªãƒ³ã‚¯ãŒå£Šã‚Œã‚‹ã‹å…¨ãé•ã†issueã¸ãƒªãƒ³ã‚¯ã—ã¦ã—ã¾ã„ã¾ã™ã€‚ã“ã‚Œã¯æœªæ¥ã®é–‹ç™ºè€…ãŒå›°ã‚‹ã®ã§å¯¾å‡¦ã—ã¾ã—ãŸã€‚ãƒãƒ¼ã‚¸æ¸ˆã¿PRã‚’æ–°ã—ã„ãƒªãƒã‚¸ãƒˆãƒªã¸ç§»è¡Œã™ã‚‹ã“ã¨ãŒé›£ã—ã„ã®ã§ã€ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã®ã€Œ#issueç•ªå·ã€ã‚’ã€Œorg/polyrepo#issueç•ªå·ã€ã®ã‚ˆã†ãªãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã«å¤‰æ›ã™ã‚‹ã“ã¨ã§å…ƒã®ãƒªãƒã‚¸ãƒˆãƒªã¸ã®ãƒªãƒ³ã‚¯ã‚’ä¿æŒã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚
* **issueã«appãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸** - project_apiãƒªãƒã‚¸ãƒˆãƒªã¨project_frontãƒªãƒã‚¸ãƒˆãƒªã®issueã‚’projectãƒªãƒã‚¸ãƒˆãƒªã«ç§»è¡Œã™ã‚‹ã¨ã€ã©ã¡ã‚‰ã®é–¢å¿ƒäº‹ã®issueãªã®ã‹ã‚’åˆ¤åˆ¥ã§ããªããªã‚‹ã“ã¨ãŒæƒ³å®šã•ã‚Œã¾ã—ãŸã€‚ã“ã‚Œã‚’é˜²ããŸã‚ã«ã€ç§»è¡Œã™ã‚‹å‰ã«å…¨ã¦ã®issueã«ã€Œapp:backendã€ã€Œapp:webã€ã®ã‚ˆã†ãªãƒ©ãƒ™ãƒ«ã‚’ä»˜ä¸ã—ã¾ã—ãŸã€‚ç§»è¡Œå¾Œã¯GitHub Projectsã®ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã«ä»˜ã‘æ›¿ãˆã‚’è¡Œã„ã¾ã—ãŸã€‚
* **CI/CDã®ä¿®æ­£** - ãã‚Œãã‚Œã®ãƒªãƒã‚¸ãƒˆãƒªã§å®Ÿè¡Œã—ã¦ã„ãŸCI/CDã‚’monorepoã«çµ±åˆã—ãŸå¾Œã‚‚å‹•ä½œã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ã“ã®æ™‚ã€å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«åŸºã¥ã„ã¦ã€ç‰¹å®šã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã ã‘ã‚’ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ã‚ˆã†ã«ã—ã¾ã—ãŸã€‚ãã†ã—ãªã‘ã‚Œã°ã€ã¡ã‚‡ã£ã¨ã—ãŸå¤‰æ›´ã‚’åŠ ãˆã‚‹ã ã‘ã§ã‚‚ã€å…¨ã¦ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ãƒ“ãƒ«ãƒ‰ã€ãƒ†ã‚¹ãƒˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã®ä¸€é€£ã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’æ¯å›è¡Œã†ã“ã¨ã«ãªã‚ŠéåŠ¹ç‡ã ã‹ã‚‰ã§ã™ã€‚

### è«¦ã‚ãŸã“ã¨

* **PRã¨ãƒ–ãƒ©ãƒ³ãƒã®ç§»è¡Œ** - æ—¢ã«project_apiãƒªãƒã‚¸ãƒˆãƒªã¨project_frontãƒªãƒã‚¸ãƒˆãƒªã§ä½œæˆã•ã‚ŒãŸPRã‚’projectãƒªãƒã‚¸ãƒˆãƒªã«ç§»è¡Œã™ã‚‹ã¨æ‰‹é–“ãŒå¢—ãˆã‚‹ã®ã§ã‚³ã‚¹ãƒˆã‚«ãƒƒãƒˆã®é¢ã§è«¦ã‚ã¾ã—ãŸã€‚ãªã®ã§ã€ç§»è¡Œä½œæ¥­ã¯ãªã‚‹ã¹ãé–‹ç™ºãŒã‚­ãƒªã‚ˆãçµ‚ã‚ã£ã¦ã„ã‚‹ã‚¹ãƒ—ãƒªãƒ³ãƒˆæœ€çµ‚æ—¥ã®é‡‘æ›œã®å¤œã«è¡Œã„ã¾ã—ãŸã€‚ãã®æ™‚ç‚¹ã§ã‚‚å–ã‚Šè¾¼ã¾ã‚Œã¦ã„ãªã„PRã¯ã‚ã‚Šã¾ã—ãŸãŒã€æ‹…å½“è€…ã«åœŸä¸‹åº§ã—ã¦ï¼ˆæ°—æŒã¡ï¼‰å¤šå°‘ä¸å®‰å®šã§ã‚‚å–ã‚Šè¾¼ã‚“ã§ã‚‚ã‚‰ã„ã¾ã—ãŸã€‚
* **ã€Œ#issueç•ªå·ã€ã§ã¯ãªã„å½¢å¼ã®issueç•ªå·ã®å¤‰æ›** - Githubã¯ã€Œ#issueç•ªå·ã€ã®å½¢å¼ã§ã¯ãªã„ã‚‚ã®ã‚’issueã¨ã—ã¦è§£é‡ˆã—ãªã„ã®ã¨ã€GitHubãŒãƒãƒ¼ã‚¸ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«å«ã‚ã‚‹ã€Œ#PRç•ªå·ã€ã‹ã‚‰é–¢é€£issueã¸è¾¿ã‚Œã‚‹ã®ã§ã€å¤‰æ›ã—ãªãã¦ã‚‚å¤§ããªæ”¯éšœã¯ãªã„ã¨åˆ¤æ–­ã—å¯¾å¿œã—ã¾ã›ã‚“ã§ã—ãŸã€‚
* **discussionsã®ç§»è¡Œ** - GitHubã®discussionsæ©Ÿèƒ½ã‚’ä¸€æ™‚æœŸä½¿ã£ã¦ã¾ã—ãŸãŒã‚ã¾ã‚Šç§ãŸã¡ã«é¦´æŸ“ã¾ãªã‹ã£ãŸã®ã§å½¢éª¸åŒ–ã—ã¾ã—ãŸã€‚ãã®ãŸã‚ã€ãã“ã«ã‚ã‚‹æƒ…å ±é‡ã¯å°‘ãªãé‡è¦ã§ãªã„ã‚‚ã®ã°ã‹ã‚Šã ã£ãŸã®ã§ã€ç§»è¡Œã®å¯¾è±¡å¤–ã¨ã—ã¾ã—ãŸã€‚æ—¢å­˜ã®polyrepoã¯æ¶ˆã•ãšã«æ®‹ã™ã®ã§ã€discussionsã¯å¿…è¦ã«ãªã£ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§ãƒãƒ‹ãƒ¥ã‚¢ãƒ«ã§ç§»è¡Œã™ã‚‹ã“ã¨ã«ã—ã¾ã—ãŸã€‚

# ç§»è¡Œä½œæ¥­

å½“æ—¥ã®ç§»è¡Œä½œæ¥­ã¯ã€ä»¥ä¸‹ã®æ‰‹é †ã§è¡Œã„ã¾ã—ãŸã€‚

1. ãƒ•ã‚¡ã‚¤ãƒ«ã¨gitå±¥æ­´ã®ç§»è¡Œ
2. issueã®ç§»è¡Œ
3. CircleCIã®è¨­å®šå¤‰æ›´
4. GitHub Actionsã®è¨­å®šå¤‰æ›´
5. GitHub Projectsã®ä¿®æ­£

## ãƒ•ã‚¡ã‚¤ãƒ«ã¨gitå±¥æ­´ã®ç§»è¡Œ

å½“æ—¥ç§ãŒå®Ÿè¡Œã—ãŸã‚³ãƒãƒ³ãƒ‰ã®å±¥æ­´ã§ã™ã€‚

```shell
# ä½œæ¥­ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir monorepo-migration-workspace && cd monorepo-migration-workspace
# tomonoã®ãŸã‚ã®ç’°å¢ƒå¤‰æ•°ã‚’è¨­å®š
export MONOREPO_NAME={monorepoå} # ç§»è¡Œå…ˆã®ãƒªãƒã‚¸ãƒˆãƒªå
# git filter-branchã®è­¦å‘Šã‚’æŠ‘åˆ¶
export FILTER_BRANCH_SQUELCH_WARNING=1
# æœ€æ–°ã®ãƒªãƒã‚¸ãƒˆãƒªã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
git clone git@github.com:moneyforward/$MONOREPO_NAME.git
git clone git@github.com:moneyforward/project_front.git
git clone git@github.com:moneyforward/project_api.git
# tomonoã‚³ãƒãƒ³ãƒ‰ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
curl https://raw.githubusercontent.com/hraban/tomono/master/tomono | sed "s/shopt -s inherit_errexit/shopt -s inherit_errexit 2>\/dev\/null || true/" > tomono && chmod 755 tomono
# tomonoã‚’ä½¿ã£ã¦project_frontã‚’webã¨ã„ã†åå‰ã§monorepoãƒ•ã‚©ãƒ«ãƒ€ã«ç§»è¡Œ
echo "$PWD/project_front web" | ./tomono --continue
# monorepoã«ç§»å‹•
cd $MONOREPO_NAME
# appsãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
mkdir apps
# webã‚’appsã«ç§»å‹•ã—ã€tomonoã®ç§»è¡Œã‚³ãƒŸãƒƒãƒˆã«è¿½åŠ 
mv web  apps
git add .
git commit --amend
# git filter-branchã§ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã®#issueç•ªå·ã‚’æ—§polyrepoã®URLã«ç½®æ›
git filter-branch --msg-filter 'sed -e "s/.*\/\(#\d*\)/\1/g" | sed -e "s/\(#\d*\)/moneyforward\/project_front\1/g"' origin/main..main
git push origin main
# ä½œæ¥­ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«æˆ»ã‚‹
cd ..
# tomonoã‚’ä½¿ã£ã¦project_apiã‚’backendã¨ã„ã†åå‰ã§monorepoãƒ•ã‚©ãƒ«ãƒ€ã«ç§»è¡Œ
echo "$PWD/project_api backend" | ./tomono --continue
# monorepoã«ç§»å‹•
cd $MONOREPO_NAME
# backendã‚’appsã«ç§»å‹•ã—ã€tomonoã®ç§»è¡Œã‚³ãƒŸãƒƒãƒˆã«è¿½åŠ 
mv backend apps
git add .
git commit --amend
# git filter-branchã§ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ä¸­ã®#issueç•ªå·ã‚’æ—§polyrepoã®URLã«ç½®æ›
git filter-branch --msg-filter 'sed -e "s/.*\/\(#\d*\)/\1/g" | sed -e "s/\(#\d*\)/moneyforward\/project_api\1/g"' origin/main..main
git push origin main
```

## issueã®ç§»è¡Œ

æ—§polyrepoã‚’ã‚¯ãƒ­ãƒ¼ãƒ³ã—ãŸãƒ•ã‚©ãƒ«ãƒ€ã§ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ã€issueã‚’ç§»è¡Œã—ã¾ã—ãŸã€‚

```shell
cd project_front
gh issue list -s open -L 100 --json number | jq -r '.[] | .number' | xargs -I% gh issue edit % --add-label "app:web"
gh issue list -s open -L 100 --json number | jq -r '.[] | .number' | xargs -I% gh issue transfer % https://github.com/moneyforward/monorepo

cd project_api
gh issue list -s open -L 100 --json number | jq -r '.[] | .number' | xargs -I% gh issue edit % --add-label "app:backend"
gh issue list -s open -L 100 --json number | jq -r '.[] | .number' | xargs -I% gh issue transfer % https://github.com/moneyforward/monorepo
```

## CircleCIã®è¨­å®šå¤‰æ›´

CircleCIã¯ç¾åœ¨è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã§ããªã„ã®ã§ã€1ã¤ã®config.ymlã—ã‹èª­ã¿å–ã‚Œã¾ã›ã‚“ã€‚ã—ã‹ã—ã€ãã†ã™ã‚‹ã¨è¤‡æ•°ã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãŸã‚ã®è¨­å®šãŒæ··åœ¨ã™ã‚‹ã®ã§ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºãŒå¤§ãããªã‚Šè¦‹é€šã—ãŒæ‚ªãç®¡ç†ã‚³ã‚¹ãƒˆãŒé«˜ããªã£ã¦ã—ã¾ã„ãã†ã§ã—ãŸã€‚ãªã®ã§ã€monorepoæ§‹æˆã§ã‚‚å¤‰ã‚ã‚‰ãšã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³å˜ä½ã§CircleCIã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç®¡ç†ã™ã‚‹æ–¹æ³•ã‚’è€ƒãˆã¾ã—ãŸã€‚

```text
.circleci
â”œ workflows // å„ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼è¨­å®šã‚’æ ¼ç´ã™ã‚‹ãƒ•ã‚©ãƒ«ãƒ€
â”‚ â”œ backend-workflow.yml
â”‚ â”” web-workflow.yml
â”œ base.yml // ãƒãƒ¼ã‚¸æ™‚ã«ãƒ™ãƒ¼ã‚¹ã«ãªã‚‹YAMLãƒ•ã‚¡ã‚¤ãƒ«
â”” config.yml // CircleCIãŒå®Ÿè¡Œã™ã‚‹YAMLãƒ•ã‚¡ã‚¤ãƒ«
```

CircleCIã§ã¯ã€[ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚³ãƒ³ãƒ•ã‚£ã‚°](https://circleci.com/docs/ja/dynamic-config/)ã¨ã„ã†config.ymlã‚’å‹•çš„ç”Ÿæˆã§ãã‚‹æ©Ÿèƒ½ã¨[Path Filtering Orb](https://circleci.com/developer/orbs/orb/circleci/path-filtering)ã¨ã„ã†å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã‚’å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹Orbã‚’çµ„ã¿åˆã‚ã›ã‚‹ã“ã¨ã§ã€å¤‰æ›´ãŒã‚ã£ãŸãƒ•ã‚¡ã‚¤ãƒ«ã«ã‚ˆã£ã¦å®Ÿè¡Œã™ã‚‹ã‚¸ãƒ§ãƒ–ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã—ã‹ã—ã€ãã®åˆ¶å¾¡ç”¨ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã¯1ã¤ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã§æ§‹æˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå˜ä½ã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä½œã‚Œãªã„å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚ã“ã®å•é¡Œã¯ã€äº‹å‰ã«åˆ†å‰²ã—ãŸYAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’CIã®ãƒ—ãƒ­ã‚»ã‚¹ä¸­ã«å‹•çš„ã«çµåˆã™ã‚‹å‡¦ç†ã‚’è¡Œã†ã“ã¨ã§è§£æ±ºã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ï¼ˆå‚è€ƒ [CircleCIã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã¦path-filteringã‚‚é©ç”¨ã™ã‚‹æ–¹æ³• - Qiita](https://qiita.com/algas/items/d0e4d460b938d924ae8f)ï¼‰

YAMLãƒ•ã‚¡ã‚¤ãƒ«ã®çµåˆã«ã¯ã€yqã‚’åˆ©ç”¨ã—ã¾ã™ã€‚circleci config packã‚³ãƒãƒ³ãƒ‰ã§ã‚‚YAMLã®çµåˆãŒã§ãã¾ã™ãŒã€æ–­ç‰‡ã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚‰ã‹ã˜ã‚æ±ºã¾ã£ãŸãƒ•ã‚©ãƒ«ãƒ€æ§‹æˆã«ãªã£ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ã‚‰ã—ã„ã®ã§ã€ä»Šå›ã®ã‚ˆã†ã«ä»»æ„ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚©ãƒ«ãƒ€åã«YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ ¼ç´ã—ãŸã„ã‚±ãƒ¼ã‚¹ã«ã¯ãƒãƒƒãƒã—ãªã„ã®ã§è¦‹é€ã‚Šã¾ã™ã€‚ï¼ˆå‚è€ƒ [Dynamic Configurationã‚’ä½¿ã£ã¦.circleci/config.ymlã‚’åˆ†å‰²ã™ã‚‹ - Zenn](https://zenn.dev/kesin11/articles/96f0947583f34d#circleci-config-pack:~:text=%E3%81%82%E3%82%89%E3%81%8B%E3%81%98%E3%82%81%E6%B1%BA%E3%81%BE%E3%81%A3%E3%81%9F%E3%83%87%E3%82%A3%E3%83%AC%E3%82%AF%E3%83%88%E3%83%AA%E6%A7%8B%E6%88%90%E3%81%AB%E5%BE%93%E3%81%A3%E3%81%A6%E5%88%86%E5%89%B2%E3%81%95%E3%82%8C%E3%81%9Fyaml%E3%81%8C%E9%85%8D%E7%BD%AE%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E5%89%8D%E6%8F%90%E3%81%A8%E3%81%AA%E3%81%A3%E3%81%A6%E3%81%8A%E3%82%8A%E3%80%81%E3%81%9D%E3%81%AE%E5%88%86%E5%89%B2%E3%81%AE%E5%8D%98%E4%BD%8D%E3%81%8Cexecutor%2C%20job%E3%81%AA%E3%81%A9%E3%81%A8%E6%B1%BA%E3%81%BE%E3%81%A3%E3%81%A6%E3%81%84%E3%82%8B%E3%81%93%E3%81%A8%E3%81%8C%E5%80%8B%E4%BA%BA%E7%9A%84%E3%81%AB%E3%81%AF%E4%BD%BF%E3%81%84%E3%81%AB%E3%81%8F%E3%81%84)ï¼‰

```yaml:.circleci/config.yml
# CircleCIãŒå®Ÿè¡Œã™ã‚‹YAMLãƒ•ã‚¡ã‚¤ãƒ«
# 1. ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆã™ã‚‹
# 2. path-filteringã§å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾å¿œã—ãŸãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã™ã‚‹
version: 2.1
setup: true # CircleCIã®ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚³ãƒ³ãƒ•ã‚£ã‚°æ©Ÿèƒ½ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã‚’å®£è¨€ã™ã‚‹
orbs:
  path-filtering: circleci/path-filtering@0.1.3
jobs:
  merge-configs:
    docker:
      - image: cimg/go:1.18.3 # yqã‚’åˆ©ç”¨ã™ã‚‹ãŸã‚ã«goã®ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’ä½¿ã†
    steps:
      - checkout
      - run:
          name: Install yq
          command: |
            go install github.com/mikefarah/yq/v4@latest
            yq --version
      - run:
          name: Merge config files
          command: |
            mkdir -p /tmp/workspace
            yq eval-all '. as $item ireduce ({}; . * $item )' ./.circleci/base.yml ./.circleci/workflows/*.yml > /tmp/workspace/merged.yml
            cat /tmp/workspace/merged.yml
      - persist_to_workspace:
          root: /tmp/workspace
          paths:
            - merged.yml
workflows:
  generate-config:
    jobs:
      - merge-configs
      - path-filtering/filter:
          requires:
            - merge-configs
          pre-steps:
            - attach_workspace:
                at: /tmp/workspace
          base-revision: main # å·®åˆ†ã‚’è¨ˆç®—ã™ã‚‹ãŸã‚ã«æ¯”è¼ƒã™ã‚‹å…ˆã®revision
          config-path: /tmp/workspace/merged.yml # mappingã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ¼ã‚’æ¸¡ã™YAMLãƒ•ã‚¡ã‚¤ãƒ«
          mapping: | # Syntax: <regex path> <pipeline parameter name> <value>
            apps/backend/.* build-backend true
            apps/web/.* build-web true
```

```yaml:.circleci/base.yml
# å…±é€šã§åˆ©ç”¨ã™ã‚‹CircleCIã®è¨­å®šå€¤ã‚’å«ã‚ã‚‹
version: 2.1
docker_hub_auth: &docker_hub_auth
  auth:
    username: $DOCKERHUB_USERNAME
    password: $DOCKERHUB_PASSWORD
workflows:
  version: 2
```

ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨ã®circleciã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¯ã€ä»¥ä¸‹ã®parametersã¨whenã‚’æ–°ã—ãè¨˜è¿°ã—ã€base.ymlã«æ›¸ã„ã¦ã‚ã‚‹é …ç›®ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚ã“ã‚Œã§ã€å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã«å¿œã˜ã¦ãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

```yaml:.circleci/workflows/*.yml
parameters:
  run-(APP NAME)-workflow:
    type: boolean
    default: false
workflows:
  (APP NAME)-workflow:
    when: << pipeline.parameters.run-(APP NAME)-workflow >>
```

æœ€å¾Œã«ã€ã“ã®ã¾ã¾ã ã¨ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã«ã‚ˆã£ã¦ç”Ÿæˆã•ã‚ŒãŸãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒãƒˆãƒªã‚¬ãƒ¼ã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒãªã„æ™‚ã«ã€CircleCIã¯ã‚¨ãƒ©ãƒ¼ã«ã—ã¦ã—ã¾ã†ã®ã§ã€å¿…ãšå®Ÿè¡Œã™ã‚‹ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’è¿½åŠ ã—ã¦ãŠãã¾ã™ã€‚

```yaml:.circleci/base.yml
jobs:
  path-filtering-fallback:
    docker:
      - image: cimg/base:2023.02
    steps:
      - run:
          name: PASS CI
          command: echo "Dynamic config is executed"
workflows:
  version: 2
  path-filtering-fallback:
    jobs:
      - path-filtering-fallback
```

:::message
âš ï¸ yqã‚³ãƒãƒ³ãƒ‰ã§YAMLãƒ•ã‚¡ã‚¤ãƒ«ã‚’çµåˆã™ã‚‹ã«ã‚ãŸã£ã¦ã€åŒä¸€ã‚­ãƒ¼åã®å€¤ã¯ä¸Šæ›¸ãã—ã¦ã—ã¾ã†ã®ã§ã€ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆç”¨circleciè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®workflowã‚„jobãªã©ã®è¨­å®šå€¤ã«ã¯ã‚¢ãƒ—ãƒªåã‚’prefixã«åŠ ãˆã‚‹ã“ã¨ã‚’è¦ç´„ã¨ã—ã¾ã—ãŸã€‚
:::

## GitHub Actionsã®è¨­å®šå¤‰æ›´

GitHubã¯ç°¡å˜ã§ã™ã€‚`on.pull_request.paths`ã§å¤‰æ›´æ¤œçŸ¥ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‘ã‚¹ã‚’æŒ‡å®šã™ã‚‹ã“ã¨ã§ã€ãã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚’å®Ÿè¡Œã§ãã¾ã™ã€‚`working-directory`ã®è¨­å®šã‚‚è¿½åŠ ã—ã¦ãŠãã¨ã€stepå®Ÿè¡Œæ™‚ã®ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å¤‰æ›´ã§ãã¾ã™ã€‚

```yaml
on:
  pull_request:
    paths:
      - 'apps/web/**'
defaults:
  run:
    shell: bash
    working-directory: ./apps/web
```

## GitHub Projectsã®ä¿®æ­£

ç§ãŸã¡ã¯GitHub Projectsã§ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’ç®¡ç†ã—ã¦ã„ã‚‹ã®ã§ã€ãã®ä¸­ã§`repo`ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã—ã¦ã„ãŸç®‡æ‰€ã‚’`app`ã‚«ã‚¹ã‚¿ãƒ é …ç›®ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã™ã‚‹ã‚ˆã†ã«ä¿®æ­£ã—ã¾ã—ãŸã€‚

# æœ€å¾Œã«

ç§ãŒé–‹ç™ºç’°å¢ƒã®ç´°ã‹ã„è¨­å®šã¾ã§æ°—ãŒå›ã‚‰ãšã€ãƒ¢ãƒãƒ¬ãƒç§»è¡Œå¾Œã«æ‰€ã€…å£Šã‚Œã¦ã—ã¾ã£ãŸéƒ¨åˆ†ãŒã‚ã‚Šã¾ã—ãŸãŒã€ãƒ¡ãƒ³ãƒãƒ¼ãŒå”åŠ›ã—ã¦åŠæ—¥ç¨‹åº¦ã§ä¿®æ­£ã—ã¦ãã‚Œã¾ã—ãŸã€‚ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã¾ãŸã€ãƒ¢ãƒãƒ¬ãƒã«ç§»è¡Œã—ãŸã“ã¨ã§å¤šãã®èª²é¡ŒãŒè§£æ¶ˆã•ã‚Œã€ãã‚Œä»¥ä¸Šã®ãƒ¡ãƒªãƒƒãƒˆã‚‚äº«å—ã§ãã¾ã—ãŸã€‚ã“ã®ç’°å¢ƒã§ä»Šå¾Œã•ã‚‰ã«é–‹ç™ºãŒåŠ é€Ÿã™ã‚‹ã“ã¨ã‚’æœŸå¾…ã—ã¦ã„ã¾ã™ã€‚

# å‚è€ƒ

- [monorepo.tools](https://monorepo.tools/)
- [Monorepoé–‹ç™ºã®ãƒ¡ãƒªãƒƒãƒˆ vs ãƒ‡ãƒ¡ãƒªãƒƒãƒˆ](https://circleci.com/ja/blog/monorepo-dev-practices/)
- [ãƒ€ã‚¤ãƒŠãƒŸãƒƒã‚¯ã‚³ãƒ³ãƒ•ã‚£ã‚° - CircleCI](https://circleci.com/docs/ja/dynamic-config/)
- [å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ç‰¹å®šã® workflows ã¾ãŸã¯ steps ã‚’å®Ÿè¡Œã™ã‚‹ - CircleCI](https://circleci.com/docs/ja/using-dynamic-configuration/#execute-specific-workflows-or-steps-based-on-which-files-are-modified)
- [Path Filtering Orb](https://circleci.com/developer/orbs/orb/circleci/path-filtering)
- [CircleCIã§è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†å‰²ã—ã¦path-filteringã‚‚é©ç”¨ã™ã‚‹æ–¹æ³• - Qiita](https://qiita.com/algas/items/d0e4d460b938d924ae8f)
- [GitHub Actions ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼æ§‹æ–‡](https://docs.github.com/ja/actions/using-workflows/workflow-syntax-for-github-actions#onpushpull_requestpull_request_targetpathspaths-ignore)
